{
  "active": true,
  "activeVersion": {
    "updatedAt": "2026-01-20T23:29:54.000Z",
    "createdAt": "2026-01-20T23:29:53.083Z",
    "versionId": "280144fb-dc67-4236-bbe4-680e9932ccaa",
    "workflowId": "Bm0xpG517GGyyLT7",
    "nodes": [
      {
        "parameters": {
          "inputSource": "passthrough"
        },
        "type": "n8n-nodes-base.executeWorkflowTrigger",
        "typeVersion": 1.1,
        "position": [
          -384,
          -112
        ],
        "id": "7ca87a47-0f33-4f44-a6cd-50d550b4abc2",
        "name": "When Executed by Another Workflow"
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "PygQxZaLVrcaZiGx",
            "mode": "list",
            "cachedResultUrl": "/workflow/PygQxZaLVrcaZiGx",
            "cachedResultName": "ZenotiNZ-GetAuthToken"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {},
            "matchingColumns": [],
            "schema": [],
            "attemptToConvertTypes": false,
            "convertFieldsToString": true
          },
          "options": {}
        },
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.3,
        "position": [
          -160,
          -112
        ],
        "id": "53205d2c-9ac9-44e8-ad6c-becf1e487fa2",
        "name": "Call 'ZenotiNZ-GetAuthToken'"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "42bc09ed-7e2a-4517-848f-e55011e3fdc9",
                "leftValue": "={{ $json.invoice.status }}",
                "rightValue": 0,
                "operator": {
                  "type": "number",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.filter",
        "typeVersion": 2.2,
        "position": [
          288,
          -112
        ],
        "id": "365acdfd-b41a-4b58-ad72-0882060a28ff",
        "name": "FilterLiveProducts",
        "alwaysOutputData": true
      },
      {
        "parameters": {
          "jsCode": "const items = $input.all();\nconst empty = items.length === 1 && Object.keys(items[0].json).length === 0;\n\n// Add the flag to the first (or only) item\nif (items.length > 0) {\n  items[0].json.empty = empty;\n  return items;\n}\n\n// If nothing came in, emit one with just the flag\nreturn [{ json: { empty: true } }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1184,
          -112
        ],
        "id": "d5427fb2-d2d9-4893-8f0c-dbb90bff43de",
        "name": "Clean for IF"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "b10b2be5-bf59-4cc5-9a6f-882cb99725eb",
                "leftValue": "={{ $json.empty }}",
                "rightValue": "",
                "operator": {
                  "type": "boolean",
                  "operation": "false",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          1408,
          -112
        ],
        "id": "02a3d76c-665b-4757-89b6-2d48e3902a65",
        "name": "If"
      },
      {
        "parameters": {
          "toRecipients": "={{ $('When Executed by Another Workflow').item.json.clinicemail }}",
          "subject": "=Automation - Med Order - {{ $('When Executed by Another Workflow').item.json.CustomerCode }}",
          "bodyContent": "=Hi Team,\n\nAutomation has failed to identify a packge with a enough products avalaible for the below customer. They where previously identified has have too many packages.\n\nName ={{ $('When Executed by Another Workflow').item.json.CustomerFirstName }} {{ $('When Executed by Another Workflow').item.json.CustomerLastName }}\nCode = {{ $('When Executed by Another Workflow').item.json.CustomerCode }}\nMeds = {{ $('When Executed by Another Workflow').item.json.quantity }} x {{ $('When Executed by Another Workflow').item.json.ProductNameCleaned }}\n\nSript URL = {{ $('When Executed by Another Workflow').item.json.scriptURL }}\n\nRegards,\nAutomation.",
          "additionalFields": {}
        },
        "type": "n8n-nodes-base.microsoftOutlook",
        "typeVersion": 2,
        "position": [
          1328,
          112
        ],
        "id": "8adea9f9-dada-4997-9d5f-c0e158ebe418",
        "name": "Send a message",
        "webhookId": "7f0de5bb-4566-4fa0-9698-1d8e350c4d53",
        "credentials": {
          "microsoftOutlookOAuth2Api": {
            "id": "syr2VMZLsiSBjaSJ",
            "name": "nryall@ash"
          }
        }
      },
      {
        "parameters": {
          "content": "## Auth and Auto Trigger",
          "height": 272,
          "width": 448
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -448,
          -224
        ],
        "typeVersion": 1,
        "id": "d0bdcfc7-6d45-4d33-83f6-73b723cc9146",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "content": "## Get Packages",
          "height": 272,
          "width": 224,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          0,
          -224
        ],
        "typeVersion": 1,
        "id": "64640869-0068-40c2-b61f-15760f9db27b",
        "name": "Sticky Note1"
      },
      {
        "parameters": {
          "content": "## Filter out Non Active",
          "height": 272,
          "width": 224
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          224,
          -224
        ],
        "typeVersion": 1,
        "id": "8c214ad8-22b1-4223-a32a-9e2fa95446ab",
        "name": "Sticky Note2"
      },
      {
        "parameters": {
          "content": "## Split Object and filter out non prescribed Meds",
          "height": 272,
          "width": 448,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          448,
          -224
        ],
        "typeVersion": 1,
        "id": "2b2fd63d-bd63-46a7-9d90-b37906c5c207",
        "name": "Sticky Note3"
      },
      {
        "parameters": {
          "content": "## Filter out 0 Quantity Pages",
          "height": 272,
          "width": 224
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          896,
          -224
        ],
        "typeVersion": 1,
        "id": "9b1c7407-a4f1-4b87-b21c-809e14f348d4",
        "name": "Sticky Note4"
      },
      {
        "parameters": {
          "content": "## If statement to check if we end up at 0 packages",
          "height": 512,
          "width": 496,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          1120,
          -224
        ],
        "typeVersion": 1,
        "id": "7614772c-c21b-47ae-b421-a9ccfec53d7a",
        "name": "Sticky Note5"
      },
      {
        "parameters": {
          "fieldToSplitOut": "products",
          "include": "selectedOtherFields",
          "fieldsToInclude": "date.end",
          "options": {}
        },
        "type": "n8n-nodes-base.splitOut",
        "typeVersion": 1,
        "position": [
          512,
          -112
        ],
        "id": "25d313f3-bdcb-40d6-b571-3ffcb5b8d7ec",
        "name": "Split Out Meds"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "0bd0f95c-5809-4116-b60a-bc307651772b",
                "leftValue": "={{ $json.products.product_type_info.name }}",
                "rightValue": "={{ $('When Executed by Another Workflow').item.json.ZenotiProductNameShort }}",
                "operator": {
                  "type": "string",
                  "operation": "startsWith"
                }
              },
              {
                "id": "d9901ce6-f9ad-48d4-ab2c-fb55dbfdfaa9",
                "leftValue": "={{ $json.products.product_type_info.name }}",
                "rightValue": "={{ $('When Executed by Another Workflow').item.json.ZenotiProductNameEnd }}",
                "operator": {
                  "type": "string",
                  "operation": "endsWith"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.filter",
        "typeVersion": 2.3,
        "position": [
          736,
          -112
        ],
        "id": "447f2772-80de-49d9-80b4-ee28ac115d1a",
        "name": "Filter Out Non Order"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "2dc4f9c7-c312-4c7c-83db-75df0889d811",
                "leftValue": "={{ $json.products.balance }}",
                "rightValue": 0,
                "operator": {
                  "type": "number",
                  "operation": "notEquals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.filter",
        "typeVersion": 2.3,
        "position": [
          960,
          -112
        ],
        "id": "c37fbc58-eb40-4b6c-ba38-19979694a40b",
        "name": "Filter Out 0 Quantity",
        "alwaysOutputData": true
      },
      {
        "parameters": {
          "jsCode": "// Items we want to OUTPUT (all fields kept)\nconst drugItems = $('When Executed by Another Workflow').all();\n\n// Pull shared values once\nconst first = $input.first().json;\nconst balance = Number(first.products.balance) || 0;\nconst productId = first.products.product_type_info.id;\n\nconst output = [];\n\nfor (let i = 0; i < drugItems.length; i++) {\n  const drugItem = drugItems[i];\n\n  const quantity = Number(drugItem.json.quantity) || 0;\n  const remaining = balance - quantity;\n\n  output.push({\n    json: {\n      ...drugItem.json,\n      CanSubtract: remaining >= 0,\n      RemainingBalance: remaining,\n      ProductID: productId,\n    },\n  });\n}\n\nreturn output;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1664,
          -128
        ],
        "id": "24f7bee8-fecb-41db-a29c-e986e61bf15b",
        "name": "Drug Compare"
      },
      {
        "parameters": {
          "content": "## Grab Data To Resent back",
          "height": 272,
          "width": 224
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          1616,
          -224
        ],
        "typeVersion": 1,
        "id": "190b5275-1e5d-4a9a-99ad-b9ce1745baf5",
        "name": "Sticky Note6"
      },
      {
        "parameters": {
          "mode": "raw",
          "jsonOutput": "=  {\n    \"AppointmentID\": \"{{ $json.AppointmentID }}\",\n    \"CustomerFirstName\": \"{{ $json.CustomerFirstName }}\",\n    \"CustomerLastName\": \"{{ $json.CustomerLastName }}\",\n    \"CustomerCode\": \"{{ $json.CustomerCode }}\",\n    \"CustomerID\": \"{{ $json.CustomerID }}\",\n    \"CustomerDOB\": \"{{ $json.CustomerDOB }}\",\n    \"CustomerEmail\": \"{{ $json.CustomerEmail }}\",\n    \"CustomerGender\": \"{{ $json.CustomerGender }}\",\n    \"CustomerCenterID\": \"{{ $json.CustomerCenterID }}\",\n    \"is_form_submitted\": {{ $json.is_form_submitted }},\n    \"textField5\": \"{{ $json.textField5 }}\",\n    \"select6\": \"{{ $json.select6 }}\",\n    \"textField2\": \"{{ $json.textField2 }}\",\n    \"textField4\": \"{{ $json.textField4 }}\",\n    \"btnFormioSubmit\": {{ $json.btnFormioSubmit }},\n    \"textField\": \"{{ $json.textField ?? null }}\",\n    \"ConsentFormFilled\": {{ $json.ConsentFormFilled }},\n    \"ConsentFormSubmitted\": {{ $json.ConsentFormSubmitted }},\n    \"DeliveryLocation\": \"{{ $json.DeliveryLocation }}\",\n    \"product\": \"{{ $json.product }}\",\n    \"quantity\": \"{{ $json.quantity }}\",\n    \"DeliveryAddressFull\": \"{{ $json.DeliveryAddressFull }}\",\n    \"doctorsDirections\": \"{{ $json.doctorsDirections }}\",\n    \"DeliveryAddress1\": \"{{ $json.DeliveryAddress1 }}\",\n    \"DeliveryCity\": \"{{ $json.DeliveryCity }}\",\n    \"addresscompared\": {{ $json.addresscompared }},\n    \"ProductNameCleaned\": \"{{ $json.ProductNameCleaned }}\",\n    \"ZenotiProductName\": \"{{ $json.ZenotiProductName }}\",\n    \"ZenotiProductNameShort\": \"{{ $json.ZenotiProductNameShort }}\",\n    \"ZenotiProductNameEnd\": \"{{ $json.ZenotiProductNameEnd }}\",\n    \"CanSubtract\": {{ $json.CanSubtract }},\n    \"RemainingBalance\": {{ $json.RemainingBalance }},\n    \"ProductID\": \"{{ $json.ProductID }}\",\n    \"packagesavailable\": true,\n    \"perfectrun\": true,\n    \"CLinicABB\": \"{{ $json.CLinicABB }}\",\n    \"scriptURL\": \"{{ $json.scriptURL }}\"\n  }",
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          1888,
          -128
        ],
        "id": "0a16c394-af0f-4eab-a126-40ba78228b56",
        "name": "Edit Fields"
      },
      {
        "parameters": {
          "amount": 1
        },
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          2272,
          -128
        ],
        "id": "4e2a1bea-ac40-4dbb-a559-8bd93df1fc41",
        "name": "Wait",
        "webhookId": "57401630-73d1-4177-bb49-144080b95426"
      },
      {
        "parameters": {
          "url": "=https://api.zenoti.com/v1/guests/{{ $('When Executed by Another Workflow').item.json.CustomerID }}/Packages",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "show_redeemable",
                "value": "false"
              },
              {
                "name": "center_id",
                "value": "={{ $('When Executed by Another Workflow').item.json.CustomerCenterID }}"
              }
            ]
          },
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Authorization",
                "value": "=bearer {{ $('Call \\'ZenotiNZ-GetAuthToken\\'').first().json.TokenSecret }}"
              },
              {
                "name": "accept",
                "value": "application/json"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          64,
          -112
        ],
        "id": "f2b33750-d55c-438e-91f4-53bf4c07110c",
        "name": "GetPackges"
      },
      {
        "parameters": {
          "content": "## Re-Order Fields",
          "height": 272,
          "width": 224,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          1840,
          -224
        ],
        "typeVersion": 1,
        "id": "92b70fe0-d22c-4ad5-95b1-2d5cc5f1b0f4",
        "name": "Sticky Note7"
      },
      {
        "parameters": {
          "jsCode": "const drugItems = $('When Executed by Another Workflow').all();\nconst first = $input.first().json;\n\nconst productId = first.products?.product_type_info?.id ?? null;\n\nreturn drugItems.map(item => ({\n  json: {\n    ...item.json,\n    CanSubtract: null,\n    RemainingBalance: null,\n    ProductID: productId,\n  },\n}));\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1664,
          112
        ],
        "id": "878db843-5119-4bb9-9afd-670027abbe0f",
        "name": "Drug Compare1"
      },
      {
        "parameters": {
          "content": "## Grab Data To Resent back",
          "height": 272,
          "width": 224
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          1616,
          16
        ],
        "typeVersion": 1,
        "id": "9ad10496-e081-48c1-bfc3-c5cc68ea15e4",
        "name": "Sticky Note8"
      },
      {
        "parameters": {
          "mode": "raw",
          "jsonOutput": "=  {\n    \"AppointmentID\": \"{{ $json.AppointmentID }}\",\n    \"CustomerFirstName\": \"{{ $json.CustomerFirstName }}\",\n    \"CustomerLastName\": \"{{ $json.CustomerLastName }}\",\n    \"CustomerCode\": \"{{ $json.CustomerCode }}\",\n    \"CustomerID\": \"{{ $json.CustomerID }}\",\n    \"CustomerDOB\": \"{{ $json.CustomerDOB }}\",\n    \"CustomerEmail\": \"{{ $json.CustomerEmail }}\",\n    \"CustomerGender\": \"{{ $json.CustomerGender }}\",\n    \"CustomerCenterID\": \"{{ $json.CustomerCenterID }}\",\n    \"is_form_submitted\": {{ $json.is_form_submitted }},\n    \"textField5\": \"{{ $json.textField5 }}\",\n    \"select6\": \"{{ $json.select6 }}\",\n    \"textField2\": \"{{ $json.textField2 }}\",\n    \"textField4\": \"{{ $json.textField4 }}\",\n    \"btnFormioSubmit\": {{ $json.btnFormioSubmit }},\n    \"textField\": \"{{ $json.textField ?? null }}\",\n    \"ConsentFormFilled\": {{ $json.ConsentFormFilled }},\n    \"ConsentFormSubmitted\": {{ $json.ConsentFormSubmitted }},\n    \"DeliveryLocation\": \"{{ $json.DeliveryLocation }}\",\n    \"product\": \"{{ $json.product }}\",\n    \"quantity\": \"{{ $json.quantity }}\",\n    \"DeliveryAddressFull\": \"{{ $json.DeliveryAddressFull }}\",\n    \"doctorsDirections\": \"{{ $json.doctorsDirections }}\",\n    \"DeliveryAddress1\": \"{{ $json.DeliveryAddress1 }}\",\n    \"DeliveryCity\": \"{{ $json.DeliveryCity }}\",\n    \"addresscompared\": {{ $json.addresscompared }},\n    \"ProductNameCleaned\": \"{{ $json.ProductNameCleaned }}\",\n    \"ZenotiProductName\": \"{{ $json.ZenotiProductName }}\",\n    \"ZenotiProductNameShort\": \"{{ $json.ZenotiProductNameShort }}\",\n    \"ZenotiProductNameEnd\": \"{{ $json.ZenotiProductNameEnd }}\",\n    \"CanSubtract\": {{ $json.CanSubtract }},\n    \"RemainingBalance\": {{ $json.RemainingBalance }},\n    \"ProductID\": \"{{ $json.ProductID }}\",\n    \"packagesavailable\": false,\n    \"perfectrun\": false,\n    \"CLinicABB\": \"{{ $json.CLinicABB }}\",\n    \"scriptURL\": \"{{ $json.scriptURL }}\"\n  }",
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          1888,
          112
        ],
        "id": "ce354c82-9e06-4625-80ca-4d1a6f9a04fb",
        "name": "Edit Fields1"
      },
      {
        "parameters": {
          "content": "## Re-Order Fields",
          "height": 272,
          "width": 224,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          1840,
          16
        ],
        "typeVersion": 1,
        "id": "7948c236-0094-4e2c-954b-b4936c19fcb3",
        "name": "Sticky Note9"
      }
    ],
    "connections": {
      "When Executed by Another Workflow": {
        "main": [
          [
            {
              "node": "Call 'ZenotiNZ-GetAuthToken'",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "FilterLiveProducts": {
        "main": [
          [
            {
              "node": "Split Out Meds",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Call 'ZenotiNZ-GetAuthToken'": {
        "main": [
          [
            {
              "node": "GetPackges",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Clean for IF": {
        "main": [
          [
            {
              "node": "If",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If": {
        "main": [
          [
            {
              "node": "Drug Compare",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Send a message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Split Out Meds": {
        "main": [
          [
            {
              "node": "Filter Out Non Order",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Filter Out Non Order": {
        "main": [
          [
            {
              "node": "Filter Out 0 Quantity",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Filter Out 0 Quantity": {
        "main": [
          [
            {
              "node": "Clean for IF",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Drug Compare": {
        "main": [
          [
            {
              "node": "Edit Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields": {
        "main": [
          [
            {
              "node": "Wait",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "GetPackges": {
        "main": [
          [
            {
              "node": "FilterLiveProducts",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send a message": {
        "main": [
          [
            {
              "node": "Drug Compare1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields1": {
        "main": [
          [
            {
              "node": "Wait",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Drug Compare1": {
        "main": [
          [
            {
              "node": "Edit Fields1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Nicholas Ryall",
    "name": "Version 280144fb",
    "description": "",
    "autosaved": false
  },
  "activeVersionId": "280144fb-dc67-4236-bbe4-680e9932ccaa",
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Call 'ZenotiNZ-GetAuthToken'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FilterLiveProducts": {
      "main": [
        [
          {
            "node": "Split Out Meds",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call 'ZenotiNZ-GetAuthToken'": {
      "main": [
        [
          {
            "node": "GetPackges",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clean for IF": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Drug Compare",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out Meds": {
      "main": [
        [
          {
            "node": "Filter Out Non Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Out Non Order": {
      "main": [
        [
          {
            "node": "Filter Out 0 Quantity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Out 0 Quantity": {
      "main": [
        [
          {
            "node": "Clean for IF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Drug Compare": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetPackges": {
      "main": [
        [
          {
            "node": "FilterLiveProducts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a message": {
      "main": [
        [
          {
            "node": "Drug Compare1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Drug Compare1": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2026-01-19T04:48:40.113Z",
  "id": "Bm0xpG517GGyyLT7",
  "isArchived": false,
  "meta": null,
  "name": "ZenotiNZ-TooManyPackages",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -384,
        -112
      ],
      "id": "7ca87a47-0f33-4f44-a6cd-50d550b4abc2",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PygQxZaLVrcaZiGx",
          "mode": "list",
          "cachedResultUrl": "/workflow/PygQxZaLVrcaZiGx",
          "cachedResultName": "ZenotiNZ-GetAuthToken"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -160,
        -112
      ],
      "id": "53205d2c-9ac9-44e8-ad6c-becf1e487fa2",
      "name": "Call 'ZenotiNZ-GetAuthToken'"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "42bc09ed-7e2a-4517-848f-e55011e3fdc9",
              "leftValue": "={{ $json.invoice.status }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        288,
        -112
      ],
      "id": "365acdfd-b41a-4b58-ad72-0882060a28ff",
      "name": "FilterLiveProducts",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst empty = items.length === 1 && Object.keys(items[0].json).length === 0;\n\n// Add the flag to the first (or only) item\nif (items.length > 0) {\n  items[0].json.empty = empty;\n  return items;\n}\n\n// If nothing came in, emit one with just the flag\nreturn [{ json: { empty: true } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1184,
        -112
      ],
      "id": "d5427fb2-d2d9-4893-8f0c-dbb90bff43de",
      "name": "Clean for IF"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b10b2be5-bf59-4cc5-9a6f-882cb99725eb",
              "leftValue": "={{ $json.empty }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1408,
        -112
      ],
      "id": "02a3d76c-665b-4757-89b6-2d48e3902a65",
      "name": "If"
    },
    {
      "parameters": {
        "toRecipients": "={{ $('When Executed by Another Workflow').item.json.clinicemail }}",
        "subject": "=Automation - Med Order - {{ $('When Executed by Another Workflow').item.json.CustomerCode }}",
        "bodyContent": "=Hi Team,\n\nAutomation has failed to identify a packge with a enough products avalaible for the below customer. They where previously identified has have too many packages.\n\nName ={{ $('When Executed by Another Workflow').item.json.CustomerFirstName }} {{ $('When Executed by Another Workflow').item.json.CustomerLastName }}\nCode = {{ $('When Executed by Another Workflow').item.json.CustomerCode }}\nMeds = {{ $('When Executed by Another Workflow').item.json.quantity }} x {{ $('When Executed by Another Workflow').item.json.ProductNameCleaned }}\n\nSript URL = {{ $('When Executed by Another Workflow').item.json.scriptURL }}\n\nRegards,\nAutomation.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        1328,
        112
      ],
      "id": "8adea9f9-dada-4997-9d5f-c0e158ebe418",
      "name": "Send a message",
      "webhookId": "7f0de5bb-4566-4fa0-9698-1d8e350c4d53",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "syr2VMZLsiSBjaSJ",
          "name": "nryall@ash"
        }
      }
    },
    {
      "parameters": {
        "content": "## Auth and Auto Trigger",
        "height": 272,
        "width": 448
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -448,
        -224
      ],
      "typeVersion": 1,
      "id": "d0bdcfc7-6d45-4d33-83f6-73b723cc9146",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Get Packages",
        "height": 272,
        "width": 224,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        0,
        -224
      ],
      "typeVersion": 1,
      "id": "64640869-0068-40c2-b61f-15760f9db27b",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## Filter out Non Active",
        "height": 272,
        "width": 224
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        224,
        -224
      ],
      "typeVersion": 1,
      "id": "8c214ad8-22b1-4223-a32a-9e2fa95446ab",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Split Object and filter out non prescribed Meds",
        "height": 272,
        "width": 448,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        448,
        -224
      ],
      "typeVersion": 1,
      "id": "2b2fd63d-bd63-46a7-9d90-b37906c5c207",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "## Filter out 0 Quantity Pages",
        "height": 272,
        "width": 224
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        896,
        -224
      ],
      "typeVersion": 1,
      "id": "9b1c7407-a4f1-4b87-b21c-809e14f348d4",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## If statement to check if we end up at 0 packages",
        "height": 512,
        "width": 496,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1120,
        -224
      ],
      "typeVersion": 1,
      "id": "7614772c-c21b-47ae-b421-a9ccfec53d7a",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "fieldToSplitOut": "products",
        "include": "selectedOtherFields",
        "fieldsToInclude": "date.end",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        512,
        -112
      ],
      "id": "25d313f3-bdcb-40d6-b571-3ffcb5b8d7ec",
      "name": "Split Out Meds"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "0bd0f95c-5809-4116-b60a-bc307651772b",
              "leftValue": "={{ $json.products.product_type_info.name }}",
              "rightValue": "={{ $('When Executed by Another Workflow').item.json.ZenotiProductNameShort }}",
              "operator": {
                "type": "string",
                "operation": "startsWith"
              }
            },
            {
              "id": "d9901ce6-f9ad-48d4-ab2c-fb55dbfdfaa9",
              "leftValue": "={{ $json.products.product_type_info.name }}",
              "rightValue": "={{ $('When Executed by Another Workflow').item.json.ZenotiProductNameEnd }}",
              "operator": {
                "type": "string",
                "operation": "endsWith"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.3,
      "position": [
        736,
        -112
      ],
      "id": "447f2772-80de-49d9-80b4-ee28ac115d1a",
      "name": "Filter Out Non Order"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "2dc4f9c7-c312-4c7c-83db-75df0889d811",
              "leftValue": "={{ $json.products.balance }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.3,
      "position": [
        960,
        -112
      ],
      "id": "c37fbc58-eb40-4b6c-ba38-19979694a40b",
      "name": "Filter Out 0 Quantity",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Items we want to OUTPUT (all fields kept)\nconst drugItems = $('When Executed by Another Workflow').all();\n\n// Pull shared values once\nconst first = $input.first().json;\nconst balance = Number(first.products.balance) || 0;\nconst productId = first.products.product_type_info.id;\n\nconst output = [];\n\nfor (let i = 0; i < drugItems.length; i++) {\n  const drugItem = drugItems[i];\n\n  const quantity = Number(drugItem.json.quantity) || 0;\n  const remaining = balance - quantity;\n\n  output.push({\n    json: {\n      ...drugItem.json,\n      CanSubtract: remaining >= 0,\n      RemainingBalance: remaining,\n      ProductID: productId,\n    },\n  });\n}\n\nreturn output;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1664,
        -128
      ],
      "id": "24f7bee8-fecb-41db-a29c-e986e61bf15b",
      "name": "Drug Compare"
    },
    {
      "parameters": {
        "content": "## Grab Data To Resent back",
        "height": 272,
        "width": 224
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1616,
        -224
      ],
      "typeVersion": 1,
      "id": "190b5275-1e5d-4a9a-99ad-b9ce1745baf5",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "=  {\n    \"AppointmentID\": \"{{ $json.AppointmentID }}\",\n    \"CustomerFirstName\": \"{{ $json.CustomerFirstName }}\",\n    \"CustomerLastName\": \"{{ $json.CustomerLastName }}\",\n    \"CustomerCode\": \"{{ $json.CustomerCode }}\",\n    \"CustomerID\": \"{{ $json.CustomerID }}\",\n    \"CustomerDOB\": \"{{ $json.CustomerDOB }}\",\n    \"CustomerEmail\": \"{{ $json.CustomerEmail }}\",\n    \"CustomerGender\": \"{{ $json.CustomerGender }}\",\n    \"CustomerCenterID\": \"{{ $json.CustomerCenterID }}\",\n    \"is_form_submitted\": {{ $json.is_form_submitted }},\n    \"textField5\": \"{{ $json.textField5 }}\",\n    \"select6\": \"{{ $json.select6 }}\",\n    \"textField2\": \"{{ $json.textField2 }}\",\n    \"textField4\": \"{{ $json.textField4 }}\",\n    \"btnFormioSubmit\": {{ $json.btnFormioSubmit }},\n    \"textField\": \"{{ $json.textField ?? null }}\",\n    \"ConsentFormFilled\": {{ $json.ConsentFormFilled }},\n    \"ConsentFormSubmitted\": {{ $json.ConsentFormSubmitted }},\n    \"DeliveryLocation\": \"{{ $json.DeliveryLocation }}\",\n    \"product\": \"{{ $json.product }}\",\n    \"quantity\": \"{{ $json.quantity }}\",\n    \"DeliveryAddressFull\": \"{{ $json.DeliveryAddressFull }}\",\n    \"doctorsDirections\": \"{{ $json.doctorsDirections }}\",\n    \"DeliveryAddress1\": \"{{ $json.DeliveryAddress1 }}\",\n    \"DeliveryCity\": \"{{ $json.DeliveryCity }}\",\n    \"addresscompared\": {{ $json.addresscompared }},\n    \"ProductNameCleaned\": \"{{ $json.ProductNameCleaned }}\",\n    \"ZenotiProductName\": \"{{ $json.ZenotiProductName }}\",\n    \"ZenotiProductNameShort\": \"{{ $json.ZenotiProductNameShort }}\",\n    \"ZenotiProductNameEnd\": \"{{ $json.ZenotiProductNameEnd }}\",\n    \"CanSubtract\": {{ $json.CanSubtract }},\n    \"RemainingBalance\": {{ $json.RemainingBalance }},\n    \"ProductID\": \"{{ $json.ProductID }}\",\n    \"packagesavailable\": true,\n    \"perfectrun\": true,\n    \"CLinicABB\": \"{{ $json.CLinicABB }}\",\n    \"scriptURL\": \"{{ $json.scriptURL }}\"\n  }",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1888,
        -128
      ],
      "id": "0a16c394-af0f-4eab-a126-40ba78228b56",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2272,
        -128
      ],
      "id": "4e2a1bea-ac40-4dbb-a559-8bd93df1fc41",
      "name": "Wait",
      "webhookId": "57401630-73d1-4177-bb49-144080b95426"
    },
    {
      "parameters": {
        "url": "=https://api.zenoti.com/v1/guests/{{ $('When Executed by Another Workflow').item.json.CustomerID }}/Packages",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "show_redeemable",
              "value": "false"
            },
            {
              "name": "center_id",
              "value": "={{ $('When Executed by Another Workflow').item.json.CustomerCenterID }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=bearer {{ $('Call \\'ZenotiNZ-GetAuthToken\\'').first().json.TokenSecret }}"
            },
            {
              "name": "accept",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        64,
        -112
      ],
      "id": "f2b33750-d55c-438e-91f4-53bf4c07110c",
      "name": "GetPackges"
    },
    {
      "parameters": {
        "content": "## Re-Order Fields",
        "height": 272,
        "width": 224,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1840,
        -224
      ],
      "typeVersion": 1,
      "id": "92b70fe0-d22c-4ad5-95b1-2d5cc5f1b0f4",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "jsCode": "const drugItems = $('When Executed by Another Workflow').all();\nconst first = $input.first().json;\n\nconst productId = first.products?.product_type_info?.id ?? null;\n\nreturn drugItems.map(item => ({\n  json: {\n    ...item.json,\n    CanSubtract: null,\n    RemainingBalance: null,\n    ProductID: productId,\n  },\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1664,
        112
      ],
      "id": "878db843-5119-4bb9-9afd-670027abbe0f",
      "name": "Drug Compare1"
    },
    {
      "parameters": {
        "content": "## Grab Data To Resent back",
        "height": 272,
        "width": 224
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1616,
        16
      ],
      "typeVersion": 1,
      "id": "9ad10496-e081-48c1-bfc3-c5cc68ea15e4",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "=  {\n    \"AppointmentID\": \"{{ $json.AppointmentID }}\",\n    \"CustomerFirstName\": \"{{ $json.CustomerFirstName }}\",\n    \"CustomerLastName\": \"{{ $json.CustomerLastName }}\",\n    \"CustomerCode\": \"{{ $json.CustomerCode }}\",\n    \"CustomerID\": \"{{ $json.CustomerID }}\",\n    \"CustomerDOB\": \"{{ $json.CustomerDOB }}\",\n    \"CustomerEmail\": \"{{ $json.CustomerEmail }}\",\n    \"CustomerGender\": \"{{ $json.CustomerGender }}\",\n    \"CustomerCenterID\": \"{{ $json.CustomerCenterID }}\",\n    \"is_form_submitted\": {{ $json.is_form_submitted }},\n    \"textField5\": \"{{ $json.textField5 }}\",\n    \"select6\": \"{{ $json.select6 }}\",\n    \"textField2\": \"{{ $json.textField2 }}\",\n    \"textField4\": \"{{ $json.textField4 }}\",\n    \"btnFormioSubmit\": {{ $json.btnFormioSubmit }},\n    \"textField\": \"{{ $json.textField ?? null }}\",\n    \"ConsentFormFilled\": {{ $json.ConsentFormFilled }},\n    \"ConsentFormSubmitted\": {{ $json.ConsentFormSubmitted }},\n    \"DeliveryLocation\": \"{{ $json.DeliveryLocation }}\",\n    \"product\": \"{{ $json.product }}\",\n    \"quantity\": \"{{ $json.quantity }}\",\n    \"DeliveryAddressFull\": \"{{ $json.DeliveryAddressFull }}\",\n    \"doctorsDirections\": \"{{ $json.doctorsDirections }}\",\n    \"DeliveryAddress1\": \"{{ $json.DeliveryAddress1 }}\",\n    \"DeliveryCity\": \"{{ $json.DeliveryCity }}\",\n    \"addresscompared\": {{ $json.addresscompared }},\n    \"ProductNameCleaned\": \"{{ $json.ProductNameCleaned }}\",\n    \"ZenotiProductName\": \"{{ $json.ZenotiProductName }}\",\n    \"ZenotiProductNameShort\": \"{{ $json.ZenotiProductNameShort }}\",\n    \"ZenotiProductNameEnd\": \"{{ $json.ZenotiProductNameEnd }}\",\n    \"CanSubtract\": {{ $json.CanSubtract }},\n    \"RemainingBalance\": {{ $json.RemainingBalance }},\n    \"ProductID\": \"{{ $json.ProductID }}\",\n    \"packagesavailable\": false,\n    \"perfectrun\": false,\n    \"CLinicABB\": \"{{ $json.CLinicABB }}\",\n    \"scriptURL\": \"{{ $json.scriptURL }}\"\n  }",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1888,
        112
      ],
      "id": "ce354c82-9e06-4625-80ca-4d1a6f9a04fb",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "content": "## Re-Order Fields",
        "height": 272,
        "width": 224,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1840,
        16
      ],
      "typeVersion": 1,
      "id": "7948c236-0094-4e2c-954b-b4936c19fcb3",
      "name": "Sticky Note9"
    }
  ],
  "origin": "n8n",
  "pinData": {},
  "repo": {
    "owner": "AMNicholasRyall",
    "name": "n8n-workflow-Backup"
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "saveDataSuccessExecution": "all",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "J83Enw8ArDSqhMCL"
  },
  "shared": [
    {
      "updatedAt": "2026-01-19T04:48:40.116Z",
      "createdAt": "2026-01-19T04:48:40.116Z",
      "role": "workflow:owner",
      "workflowId": "Bm0xpG517GGyyLT7",
      "projectId": "gMwV5v9nxJB6matq"
    }
  ],
  "staticData": null,
  "tags": [
    {
      "updatedAt": "2025-11-07T01:33:39.006Z",
      "createdAt": "2025-11-07T01:33:39.006Z",
      "id": "WIsNIXL4vR1ZWj36",
      "name": "Zenoti"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2026-01-20T23:29:53.082Z",
  "versionId": "280144fb-dc67-4236-bbe4-680e9932ccaa"
}